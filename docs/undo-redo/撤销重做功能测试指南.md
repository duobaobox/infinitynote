# 撤销重做功能测试指南

## 🎯 测试目标

验证撤销重做功能在实际使用中是否正常工作。

## ✅ 已集成的功能

### 便签操作（5 种）

- ✅ 创建便签 - `noteStore.createNote()`
- ✅ 删除便签 - `noteStore.deleteNote()`
- ✅ 移动便签 - `noteStore.moveNote()`
- ✅ 调整大小 - `noteStore.resizeNote()`
- ✅ 批量删除 - `noteStore.deleteNotes()`

### 快捷键

- ✅ Ctrl+Z / Cmd+Z - 撤销
- ✅ Ctrl+Y / Cmd+Shift+Z - 重做

### UI 组件

- ✅ 撤销/重做按钮 - 位于左侧边栏顶部工具栏
- ✅ 状态显示 - 按钮自动启用/禁用

## 📋 测试步骤

### 测试 1：创建便签的撤销

1. 在画布上创建一个新便签
2. 确认便签已创建
3. 按 `Ctrl+Z` 或点击撤销按钮
4. **预期结果**：便签消失
5. 按 `Ctrl+Y` 或点击重做按钮
6. **预期结果**：便签重新出现

### 测试 2：删除便签的撤销

1. 选中一个便签
2. 删除该便签（Delete 键或右键菜单）
3. 确认便签已删除
4. 按 `Ctrl+Z`
5. **预期结果**：便签恢复（位置、内容、样式都正确）
6. 按 `Ctrl+Y`
7. **预期结果**：便签再次被删除

### 测试 3：移动便签的撤销

1. 拖动一个便签到新位置
2. 释放鼠标，确认便签已移动
3. 按 `Ctrl+Z`
4. **预期结果**：便签回到原位置
5. 按 `Ctrl+Y`
6. **预期结果**：便签回到新位置

### 测试 4：连续移动的合并

1. 拖动一个便签，连续移动多次（在 500ms 内）
2. 按 `Ctrl+Z` 一次
3. **预期结果**：便签直接回到最初位置（不是中间位置）
4. **验证**：多次连续移动被合并为一次操作

### 测试 5：调整大小的撤销

1. 调整一个便签的大小
2. 按 `Ctrl+Z`
3. **预期结果**：便签大小恢复
4. 按 `Ctrl+Y`
5. **预期结果**：便签大小变回调整后的状态

### 测试 6：批量删除的撤销

1. 选中多个便签（Ctrl+点击或框选）
2. 批量删除（Delete 键）
3. 确认所有便签都被删除
4. 按 `Ctrl+Z`
5. **预期结果**：所有便签都恢复
6. 按 `Ctrl+Y`
7. **预期结果**：所有便签再次被删除

### 测试 7：混合操作序列

1. 创建便签 A
2. 移动便签 A
3. 创建便签 B
4. 删除便签 A
5. 按 `Ctrl+Z` 四次
6. **预期结果**：
   - 第 1 次：便签 A 恢复
   - 第 2 次：便签 B 消失
   - 第 3 次：便签 A 回到原位置
   - 第 4 次：便签 A 消失
7. 按 `Ctrl+Y` 四次
8. **预期结果**：完全恢复到步骤 4 的状态

### 测试 8：快捷键与按钮一致性

1. 执行任意操作
2. 用快捷键撤销（Ctrl+Z）
3. 用按钮重做
4. 用按钮撤销
5. 用快捷键重做
6. **预期结果**：快捷键和按钮效果一致

### 测试 9：编辑器排除测试

1. 双击便签进入编辑模式
2. 在编辑器中输入文字
3. 在编辑器内按 `Ctrl+Z`
4. **预期结果**：只撤销编辑器内的文字输入
5. 退出编辑器
6. 在画布上按 `Ctrl+Z`
7. **预期结果**：撤销画布级别的操作（如创建/删除便签）

### 测试 10：UI 状态测试

1. 刚打开应用时
   - **预期**：撤销和重做按钮都是禁用状态
2. 创建一个便签后
   - **预期**：撤销按钮启用，重做按钮禁用
3. 撤销后
   - **预期**：撤销按钮可能禁用（如果没有更多历史），重做按钮启用
4. 重做后
   - **预期**：撤销按钮启用，重做按钮可能禁用
5. 执行新操作后
   - **预期**：重做按钮立即禁用

## 🐛 常见问题排查

### 问题 1：撤销没有反应

**可能原因**：

- 历史记录没有正确记录
- 快捷键被其他组件拦截

**检查**：

1. 打开浏览器控制台
2. 查看是否有"记录历史"的日志
3. 检查是否在编辑器内（编辑器会拦截快捷键）

### 问题 2：撤销后数据不正确

**可能原因**：

- Command 的 undo 方法实现有误
- 数据没有正确保存

**检查**：

1. 查看控制台错误信息
2. 检查数据库中的数据
3. 验证 Command 类的实现

### 问题 3：操作合并不生效

**可能原因**：

- 操作间隔超过 500ms
- canMergeWith 方法返回 false

**检查**：

1. 快速连续操作（500ms 内）
2. 查看控制台是否有"命令已合并"的日志

### 问题 4：便签 ID 改变

**说明**：

- 这是预期行为
- 删除操作撤销后，由于数据库主键约束，新创建的便签会有新 ID
- 不影响用户体验，但开发时需注意

## 📊 测试检查表

```
□ 测试1：创建便签的撤销 - 通过 / 失败
□ 测试2：删除便签的撤销 - 通过 / 失败
□ 测试3：移动便签的撤销 - 通过 / 失败
□ 测试4：连续移动的合并 - 通过 / 失败
□ 测试5：调整大小的撤销 - 通过 / 失败
□ 测试6：批量删除的撤销 - 通过 / 失败
□ 测试7：混合操作序列 - 通过 / 失败
□ 测试8：快捷键与按钮一致性 - 通过 / 失败
□ 测试9：编辑器排除测试 - 通过 / 失败
□ 测试10：UI状态测试 - 通过 / 失败
```

## 🔍 调试技巧

### 查看历史栈

在浏览器控制台输入：

```javascript
// 查看撤销栈
window.useHistoryStore.getState().undoStack;

// 查看重做栈
window.useHistoryStore.getState().redoStack;

// 查看是否可以撤销/重做
window.useHistoryStore.getState().canUndo;
window.useHistoryStore.getState().canRedo;
```

### 查看便签状态

```javascript
// 查看所有便签
window.useNoteStore.getState().notes;

// 查看选中的便签
window.useNoteStore.getState().selectedNoteIds;
```

### 手动执行撤销/重做

```javascript
// 手动撤销
await window.useHistoryStore.getState().undo();

// 手动重做
await window.useHistoryStore.getState().redo();
```

## ✅ 测试通过标准

所有 10 个测试都应该通过，并且：

1. 操作响应及时（<100ms）
2. UI 状态正确更新
3. 无控制台错误
4. 无内存泄漏
5. 操作合并正常工作

## 📝 测试报告模板

```
测试日期：____/____/____
测试人员：________________
浏览器：_________________
操作系统：_______________

测试结果：
- 通过：__ / 10
- 失败：__ / 10

失败详情：
1. 测试X：[描述问题]
2. ...

性能表现：
- 撤销响应时间：____ms
- 重做响应时间：____ms
- UI更新延迟：____ms

其他发现：
- [记录任何意外发现或改进建议]
```

## 🎉 完成后

测试通过后，撤销重做功能即可投入正常使用！

如果发现任何问题，请参考：

- `撤销重做功能说明.md` - 功能文档
- `Store历史记录集成示例.ts` - 集成参考
- `撤销重做功能实施总结.md` - 技术文档
