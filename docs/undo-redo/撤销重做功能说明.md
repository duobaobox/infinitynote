# 撤销重做功能使用指南

## 📋 功能概述

InfinityNote2 现在支持全局的撤销/重做功能，可以撤销和重做几乎所有的操作。

## ✨ 支持的操作

### 便签操作

- ✅ 创建便签
- ✅ 删除便签
- ✅ 移动便签
- ✅ 调整便签大小
- ✅ 更新便签内容/颜色/属性
- ✅ 批量移动便签
- ✅ 批量删除便签

### 画布操作

- ✅ 创建画布
- ✅ 删除画布
- ✅ 切换画布
- ✅ 缩放画布
- ✅ 平移画布

### 不支持的操作

- ❌ TipTap 编辑器内的文本编辑（编辑器有独立的撤销重做）

## ⌨️ 快捷键

| 操作 | Windows/Linux | macOS       |
| ---- | ------------- | ----------- |
| 撤销 | `Ctrl + Z`    | `⌘ + Z`     |
| 重做 | `Ctrl + Y`    | `⌘ + ⇧ + Z` |

**注意**：在编辑器中输入时，快捷键会被编辑器拦截，使用编辑器自己的撤销重做功能。

## 🎨 UI 组件

### 历史指示器

位于画布右下角，显示：

- 撤销按钮（包含快捷键提示）
- 重做按钮（包含快捷键提示）
- 历史记录列表按钮（可选）

按钮状态：

- **可用**：按钮高亮，可以点击
- **不可用**：按钮灰色，无法点击

## 🔧 技术实现

### 架构设计

采用 **Command 模式**，每个可撤销的操作都被封装为一个命令对象，包含：

- `execute()`: 执行操作
- `undo()`: 撤销操作
- `canMergeWith()`: 是否可与其他命令合并
- `mergeWith()`: 合并命令

### 操作合并

连续的相同类型操作（如拖动便签）会在 500ms 时间窗口内自动合并，避免历史栈膨胀。

### 历史栈管理

- 默认最大历史记录：50 条
- 超过限制时自动移除最旧的记录
- 执行新操作时清空重做栈

### Store 集成

- `historyStore`: 管理历史记录栈
- `HistoryHelper`: 提供便捷的记录方法
- Command 类: 封装具体操作

## 📝 使用示例

### 记录操作（在 Store 中）

```typescript
import { HistoryHelper } from "../utils/historyHelper";

// 记录便签创建
HistoryHelper.recordNoteCreation(note);

// 记录便签移动
HistoryHelper.recordNoteMove(noteId, oldPosition, newPosition);

// 记录便签删除
HistoryHelper.recordNoteDeletion(note);
```

### 手动撤销/重做

```typescript
import { HistoryHelper } from "../utils/historyHelper";

// 撤销
await HistoryHelper.undo();

// 重做
await HistoryHelper.redo();

// 检查状态
const canUndo = HistoryHelper.canUndo();
const canRedo = HistoryHelper.canRedo();
```

### 使用历史指示器组件

```tsx
import { HistoryIndicator } from './components/HistoryIndicator';

// 基础用法
<HistoryIndicator />

// 显示历史记录列表
<HistoryIndicator showHistory={true} />

// 自定义位置
<HistoryIndicator position="top-right" />
```

## 🚀 性能优化

1. **操作合并**: 连续的相似操作会自动合并
2. **历史限制**: 只保留最近 50 条操作
3. **按需执行**: 撤销/重做时才执行数据库操作
4. **内存管理**: 超过限制时自动清理旧记录

## 🔮 未来计划

- [ ] 持久化历史记录（跨会话保存）
- [ ] 历史记录时间线可视化
- [ ] 分支历史（类似 Git 的分支）
- [ ] 历史记录导出/导入
- [ ] 更细粒度的编辑器集成

## ⚠️ 注意事项

1. **数据库约束**: 删除操作撤销后，便签 ID 会改变（数据库主键约束）
2. **编辑器独立性**: 编辑器内的文本编辑有自己的撤销重做系统
3. **性能考虑**: 大批量操作可能导致撤销较慢
4. **内存占用**: 历史记录会占用内存，已设置合理限制

## 📖 相关文件

### 核心文件

- `src/store/historyStore.ts` - 历史记录管理
- `src/types/history.ts` - 类型定义
- `src/commands/` - 命令实现
- `src/utils/historyHelper.ts` - 辅助工具

### UI 组件

- `src/components/HistoryIndicator/` - 历史指示器组件
- `src/hooks/useHistoryShortcuts.ts` - 快捷键 Hook

### 集成点

- `src/App.tsx` - 全局快捷键启用
- `src/pages/Canvas/index.tsx` - UI 组件集成
