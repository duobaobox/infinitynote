# æ‚¬æµ®ä¾¿ç­¾åŠŸèƒ½å®Œæ•´å®ç°æŒ‡å—

## ğŸ“‹ ç›®å½•
- [åŠŸèƒ½æ¦‚è¿°](#åŠŸèƒ½æ¦‚è¿°)
- [æŠ€æœ¯æ¶æ„](#æŠ€æœ¯æ¶æ„)
- [æ ¸å¿ƒå®ç°](#æ ¸å¿ƒå®ç°)
- [å…³é”®æŠ€æœ¯ç‚¹](#å…³é”®æŠ€æœ¯ç‚¹)
- [æ•°æ®æµè®¾è®¡](#æ•°æ®æµè®¾è®¡)
- [å®Œæ•´ä»£ç å®ç°](#å®Œæ•´ä»£ç å®ç°)
- [å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ](#å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ)

---

## åŠŸèƒ½æ¦‚è¿°

### ä»€ä¹ˆæ˜¯æ‚¬æµ®ä¾¿ç­¾ï¼Ÿ
æ‚¬æµ®ä¾¿ç­¾æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ã€å§‹ç»ˆç½®é¡¶çš„æ¡Œé¢çª—å£ï¼Œç”¨æˆ·å¯ä»¥å°†ç”»å¸ƒä¸­çš„ä»»æ„ä¾¿ç­¾"æå–"å‡ºæ¥ï¼Œä»¥æ‚¬æµ®çª—çš„å½¢å¼å›ºå®šåœ¨æ¡Œé¢ä¸Šï¼Œæ–¹ä¾¿éšæ—¶æŸ¥çœ‹å’Œç¼–è¾‘ã€‚

### æ ¸å¿ƒç‰¹æ€§
1. **ç‹¬ç«‹çª—å£**ï¼šæ¯ä¸ªæ‚¬æµ®ä¾¿ç­¾éƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ Electron BrowserWindow
2. **å§‹ç»ˆç½®é¡¶**ï¼šæ‚¬æµ®çª—å£æ°¸è¿œæ˜¾ç¤ºåœ¨å…¶ä»–çª—å£ä¹‹ä¸Š
3. **æ— è¾¹æ¡†è®¾è®¡**ï¼šé€æ˜èƒŒæ™¯ + æ— è¾¹æ¡†ï¼Œæä¾›ç°ä»£åŒ–çš„è§†è§‰ä½“éªŒ
4. **å¯æ‹–æ‹½ç§»åŠ¨**ï¼šé€šè¿‡æ ‡é¢˜æ æ‹–æ‹½ç§»åŠ¨çª—å£ä½ç½®
5. **å¯è°ƒæ•´å¤§å°**ï¼šæ”¯æŒçª—å£å¤§å°è°ƒæ•´
6. **åŒå‘åŒæ­¥**ï¼šæ‚¬æµ®ä¾¿ç­¾ä¸åŸå§‹ä¾¿ç­¾æ•°æ®å®æ—¶åŒæ­¥
7. **ç‹¬ç«‹ç¼–è¾‘**ï¼šåœ¨æ‚¬æµ®çª—ä¸­å¯ä»¥ç‹¬ç«‹ç¼–è¾‘æ ‡é¢˜å’Œå†…å®¹
8. **è·¨å¹³å°**ï¼šæ”¯æŒ Windowsã€macOSã€Linux

---

## æŠ€æœ¯æ¶æ„

### æ•´ä½“æ¶æ„å›¾
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ä¸»çª—å£ (Main Window)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚             æ— é™ç”»å¸ƒ (Infinite Canvas)                  â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚ â”‚
â”‚  â”‚  â”‚ ä¾¿ç­¾ 1    â”‚  â”‚ ä¾¿ç­¾ 2    â”‚  â”‚ ä¾¿ç­¾ 3    â”‚             â”‚ â”‚
â”‚  â”‚  â”‚          â”‚  â”‚          â”‚  â”‚  [æµ®çª—]   â”‚             â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“ ç‚¹å‡»"æ‚¬æµ®"æŒ‰é’®
                          â†“ IPC é€šä¿¡
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Electron Main Process                     â”‚
â”‚          createFloatingNoteWindow(noteData)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“ åˆ›å»ºæ–°çª—å£
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ‚¬æµ®çª—å£ (Floating Window)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  [æ‹–æ‹½åŒºåŸŸ - å¯ç§»åŠ¨çª—å£]                    [Ã—å…³é—­]    â”‚ â”‚
â”‚  â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚ â”‚
â”‚  â”‚  æ ‡é¢˜ï¼šä¾¿ç­¾æ ‡é¢˜                                        â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚ â”‚
â”‚  â”‚  å†…å®¹åŒºåŸŸ                                              â”‚ â”‚
â”‚  â”‚  - æ”¯æŒå¯Œæ–‡æœ¬ç¼–è¾‘                                      â”‚ â”‚
â”‚  â”‚  - å®æ—¶åŒæ­¥åˆ°ä¸»çª—å£                                    â”‚ â”‚
â”‚  â”‚                                                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚          â†• åŒå‘æ•°æ®åŒæ­¥ (IPC é€šä¿¡)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æŠ€æœ¯æ ˆ
- **Electron**: è·¨å¹³å°æ¡Œé¢åº”ç”¨æ¡†æ¶
- **React**: å‰ç«¯ UI æ¡†æ¶
- **TypeScript**: ç±»å‹å®‰å…¨
- **IPC (è¿›ç¨‹é—´é€šä¿¡)**: ä¸»è¿›ç¨‹ä¸æ¸²æŸ“è¿›ç¨‹é€šä¿¡
- **Context Bridge**: å®‰å…¨çš„ API æš´éœ²

---

## æ ¸å¿ƒå®ç°

### 1. Electron ä¸»è¿›ç¨‹é…ç½® (main.cjs)

#### 1.1 å…¨å±€å˜é‡ç®¡ç†
```javascript
// æ‚¬æµ®çª—å£ç®¡ç† - ä½¿ç”¨ Map ç®¡ç†å¤šä¸ªæ‚¬æµ®çª—å£
let floatingWindows = new Map(); // key: noteId, value: BrowserWindow

// ä¸»çª—å£å¼•ç”¨
let mainWindow;
```

#### 1.2 åˆ›å»ºæ‚¬æµ®çª—å£å‡½æ•°
```javascript
function createFloatingNoteWindow(noteData) {
  const { noteId, title, content, color, width, height } = noteData;

  // 1ï¸âƒ£ æ£€æŸ¥çª—å£æ˜¯å¦å·²å­˜åœ¨
  if (floatingWindows.has(noteId)) {
    const existingWindow = floatingWindows.get(noteId);
    if (!existingWindow.isDestroyed()) {
      existingWindow.focus();
      existingWindow.show();
      return existingWindow;
    } else {
      floatingWindows.delete(noteId);
    }
  }

  // 2ï¸âƒ£ åˆ›å»ºæ–°çš„æ‚¬æµ®çª—å£
  const floatingWindow = new BrowserWindow({
    width: Math.max(width, 300),        // æœ€å°å®½åº¦ 300px
    height: Math.max(height, 200),      // æœ€å°é«˜åº¦ 200px
    minWidth: 250,
    minHeight: 150,
    frame: false,                       // â­ æ— è¾¹æ¡†çª—å£
    transparent: true,                  // â­ é€æ˜èƒŒæ™¯
    alwaysOnTop: true,                  // â­ å§‹ç»ˆåœ¨é¡¶éƒ¨
    resizable: true,                    // å¯è°ƒæ•´å¤§å°
    movable: true,                      // å¯ç§»åŠ¨
    skipTaskbar: false,                 // åœ¨ä»»åŠ¡æ ä¸­æ˜¾ç¤º
    title: `æ‚¬æµ®ä¾¿ç­¾ - ${title || "æ— æ ‡é¢˜"}`,
    webPreferences: {
      nodeIntegration: false,
      contextIsolation: true,
      enableRemoteModule: false,
      preload: path.join(__dirname, "preload.cjs"),
      webSecurity: !isDev,
    },
    show: false,                        // å»¶è¿Ÿæ˜¾ç¤º
  });

  // 3ï¸âƒ£ åŠ è½½æ‚¬æµ®é¡µé¢
  const floatingUrl = isDev
    ? `http://localhost:5173/floating.html?noteId=${encodeURIComponent(noteId)}`
    : `file://${path.join(__dirname, "../dist/floating.html")}?noteId=${encodeURIComponent(noteId)}`;

  floatingWindow.loadURL(floatingUrl);

  // 4ï¸âƒ£ çª—å£å‡†å¤‡æ˜¾ç¤ºæ—¶çš„å›è°ƒ
  floatingWindow.once("ready-to-show", () => {
    floatingWindow.show();
    floatingWindow.focus();

    // å‘é€ä¾¿ç­¾æ•°æ®åˆ°æ¸²æŸ“è¿›ç¨‹
    setTimeout(() => {
      if (!floatingWindow.isDestroyed()) {
        floatingWindow.webContents.send("note-data", noteData);
      }
    }, 500); // å»¶è¿Ÿç¡®ä¿é¡µé¢å®Œå…¨åŠ è½½
  });

  // 5ï¸âƒ£ çª—å£å…³é—­æ—¶æ¸…ç†
  floatingWindow.on("closed", () => {
    floatingWindows.delete(noteId);
  });

  // 6ï¸âƒ£ ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼ŒåŒæ­¥åˆ°ä¸»çª—å£
  floatingWindow.on("resize", () => {
    if (!floatingWindow.isDestroyed()) {
      const bounds = floatingWindow.getBounds();
      if (mainWindow && !mainWindow.isDestroyed()) {
        mainWindow.webContents.send("floating-note-resized", {
          noteId,
          width: bounds.width,
          height: bounds.height,
        });
      }
    }
  });

  // 7ï¸âƒ£ å­˜å‚¨çª—å£å¼•ç”¨
  floatingWindows.set(noteId, floatingWindow);

  return floatingWindow;
}
```

#### 1.3 IPC å¤„ç†ç¨‹åº
```javascript
// åˆ›å»ºæ‚¬æµ®ä¾¿ç­¾
ipcMain.handle("create-floating-note", (event, noteData) => {
  try {
    createFloatingNoteWindow(noteData);
    return { success: true };
  } catch (error) {
    console.error("åˆ›å»ºæ‚¬æµ®ä¾¿ç­¾å¤±è´¥:", error);
    return { success: false, error: error.message };
  }
});

// å…³é—­æ‚¬æµ®ä¾¿ç­¾
ipcMain.handle("close-floating-note", (event, noteId) => {
  try {
    const window = floatingWindows.get(noteId);
    if (window && !window.isDestroyed()) {
      window.close();
    }
    floatingWindows.delete(noteId);
    return { success: true };
  } catch (error) {
    console.error("å…³é—­æ‚¬æµ®ä¾¿ç­¾å¤±è´¥:", error);
    return { success: false, error: error.message };
  }
});

// æ›´æ–°æ‚¬æµ®ä¾¿ç­¾ - åŒå‘åŒæ­¥çš„æ ¸å¿ƒ
ipcMain.handle("update-floating-note", (event, noteId, updates) => {
  try {
    const window = floatingWindows.get(noteId);
    
    // æ›´æ–°æ‚¬æµ®çª—å£
    if (window && !window.isDestroyed()) {
      window.webContents.send("note-data-updated", { noteId, ...updates });
    }

    // åŒæ—¶é€šçŸ¥ä¸»çª—å£æ›´æ–°
    if (mainWindow && !mainWindow.isDestroyed()) {
      mainWindow.webContents.send("floating-note-updated", {
        noteId,
        updates,
      });
    }

    return { success: true };
  } catch (error) {
    console.error("æ›´æ–°æ‚¬æµ®ä¾¿ç­¾å¤±è´¥:", error);
    return { success: false, error: error.message };
  }
});

// è·å–æ‚¬æµ®ä¾¿ç­¾æ•°æ®
ipcMain.handle("get-floating-note-data", (event, noteId) => {
  try {
    return { success: true };
  } catch (error) {
    console.error("è·å–æ‚¬æµ®ä¾¿ç­¾æ•°æ®å¤±è´¥:", error);
    return { success: false, error: error.message };
  }
});
```

---

### 2. Preload è„šæœ¬ (preload.cjs)

```javascript
const { contextBridge, ipcRenderer } = require("electron");

contextBridge.exposeInMainWorld("electronAPI", {
  // æ‚¬æµ®ä¾¿ç­¾åŠŸèƒ½ - æš´éœ²ç»™æ¸²æŸ“è¿›ç¨‹çš„ API
  createFloatingNote: (noteData) =>
    ipcRenderer.invoke("create-floating-note", noteData),
  
  closeFloatingNote: (noteId) =>
    ipcRenderer.invoke("close-floating-note", noteId),
  
  updateFloatingNote: (noteId, updates) =>
    ipcRenderer.invoke("update-floating-note", noteId, updates),
  
  getFloatingNoteData: (noteId) =>
    ipcRenderer.invoke("get-floating-note-data", noteId),

  // èœå•äº‹ä»¶ç›‘å¬
  onMenuAction: (callback) => {
    const menuEvents = [
      "note-data",              // æ‚¬æµ®ä¾¿ç­¾æ•°æ®
      "note-data-updated",      // ä¾¿ç­¾æ•°æ®æ›´æ–°
      "floating-note-updated",  // æ‚¬æµ®ä¾¿ç­¾æ›´æ–°é€šçŸ¥ä¸»çª—å£
      // ... å…¶ä»–äº‹ä»¶
    ];

    const handlers = {};

    menuEvents.forEach((event) => {
      const handler = (electronEvent, data) => {
        callback(event, data);
      };
      handlers[event] = handler;
      ipcRenderer.on(event, handler);
    });

    // è¿”å›æ¸…ç†å‡½æ•°
    return () => {
      menuEvents.forEach((event) => {
        if (handlers[event]) {
          ipcRenderer.removeListener(event, handlers[event]);
        }
      });
    };
  },

  // å¹³å°ä¿¡æ¯
  platform: process.platform,
  isDev: process.env.NODE_ENV === "development",
  isElectron: true,
});
```

---

### 3. æ‚¬æµ®çª—å£ HTML (floating.html)

```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/icon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ‚¬æµ®ä¾¿ç­¾ - Infinity Notes</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 
                         'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            -webkit-font-smoothing: antialiased;
            overflow: hidden;
        }

        #root {
            height: 100%;
            width: 100%;
        }

        /* æ‚¬æµ®çª—å£ä¸“ç”¨æ ·å¼ */
        .floating-window {
            height: 100vh;
            width: 100vw;
            background: transparent;
            position: relative;
        }

        /* â­ å…³é”®ï¼šå¯ç”¨æ‹–æ‹½åŠŸèƒ½ */
        .floating-drag-area {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 32px;
            -webkit-app-region: drag;  /* å¯ç”¨æ‹–æ‹½ */
            background: rgba(0, 0, 0, 0.02);
            z-index: 1000;
        }

        /* æ‚¬æµ®çª—å£å…³é—­æŒ‰é’® */
        .floating-close-button {
            position: absolute;
            top: 6px;
            right: 8px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(255, 95, 87, 0.8);
            border: none;
            cursor: pointer;
            color: white;
            font-size: 12px;
            z-index: 1001;
            -webkit-app-region: no-drag;  /* æŒ‰é’®åŒºåŸŸç¦ç”¨æ‹–æ‹½ */
        }

        /* éšè—åŸå§‹ä¾¿ç­¾çš„æŸäº›å…ƒç´  */
        .floating-note-wrapper .settings-toolbar {
            display: none !important;  /* éšè—è®¾ç½®å·¥å…·æ  */
        }

        .floating-note-wrapper .connection-point {
            display: none !important;  /* éšè—è¿æ¥ç‚¹ */
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="module" src="/src/pages/FloatingNote.tsx"></script>
</body>
</html>
```

---

### 4. æ‚¬æµ®çª—å£ React ç»„ä»¶ (FloatingNote.tsx)

```typescript
import React, { useEffect, useState, useCallback, useRef } from "react";
import ReactDOM from "react-dom/client";
import { ConfigProvider, Button } from "antd";
import { CloseOutlined } from "@ant-design/icons";
import zhCN from "antd/locale/zh_CN";
import TitleEditor from "../components/notes/TitleEditor";
import BasicEditor from "../components/notes/BasicEditor";
import BasicToolbar from "../components/notes/BasicToolbar";
import { useDebounce } from "../hooks";
import type { StickyNote as StickyNoteType } from "../components/types";

interface FloatingNoteData {
  noteId: string;
  title: string;
  content: string;
  color: string;
  width: number;
  height: number;
  isEditing?: boolean;
  isTitleEditing?: boolean;
}

const FloatingNote: React.FC = () => {
  // ===== çŠ¶æ€ç®¡ç† =====
  const [noteData, setNoteData] = useState<StickyNoteType | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [isInitialized, setIsInitialized] = useState(false);
  const [isEditing, setIsEditing] = useState(false);
  const [isTitleEditing, setIsTitleEditing] = useState(false);
  const [localTitle, setLocalTitle] = useState("");
  const [localContent, setLocalContent] = useState("");
  const [editorInstance, setEditorInstance] = useState<any>(null);
  const [windowWidth, setWindowWidth] = useState(window.innerWidth || 300);

  // ===== å®šæ—¶å™¨ç®¡ç† =====
  const timersRef = useRef<Set<NodeJS.Timeout>>(new Set());

  const safeSetTimeout = useCallback((callback: () => void, delay: number) => {
    const timer = setTimeout(() => {
      timersRef.current.delete(timer);
      callback();
    }, delay);
    timersRef.current.add(timer);
    return timer;
  }, []);

  useEffect(() => {
    return () => {
      timersRef.current.forEach((timer) => clearTimeout(timer));
      timersRef.current.clear();
    };
  }, []);

  // ===== URL å‚æ•°è§£æ =====
  const urlParams = new URLSearchParams(window.location.search);
  const noteId = urlParams.get("noteId");

  // ===== ç›‘å¬çª—å£å¤§å°å˜åŒ– =====
  useEffect(() => {
    const handleResize = () => {
      setWindowWidth(window.innerWidth);
    };
    window.addEventListener("resize", handleResize);
    return () => window.removeEventListener("resize", handleResize);
  }, []);

  // ===== é˜²æŠ–ä¿å­˜å†…å®¹ =====
  const [debouncedSaveContent] = useDebounce((content: string) => {
    if (noteData && content !== noteData.content && 
        window.electronAPI?.updateFloatingNote) {
      setNoteData((prev) => (prev ? { ...prev, content } : null));
      window.electronAPI.updateFloatingNote(noteData.id, { content });
    }
  }, 300);

  // ===== é˜²æŠ–ä¿å­˜æ ‡é¢˜ =====
  const [debouncedSaveTitle] = useDebounce((title: string) => {
    if (noteData && title !== noteData.title && 
        window.electronAPI?.updateFloatingNote) {
      setNoteData((prev) => (prev ? { ...prev, title } : null));
      window.electronAPI.updateFloatingNote(noteData.id, { title });
    }
  }, 300);

  // ===== æ ‡é¢˜å˜åŒ–å¤„ç† =====
  const handleTitleChange = useCallback(
    (newTitle: string) => {
      setLocalTitle(newTitle);
      debouncedSaveTitle(newTitle);
    },
    [debouncedSaveTitle]
  );

  // ===== å†…å®¹å˜åŒ–å¤„ç† =====
  const handleContentChange = useCallback(
    (newContent: string) => {
      setLocalContent(newContent);
      debouncedSaveContent(newContent);
    },
    [debouncedSaveContent]
  );

  // ===== ç¼–è¾‘çŠ¶æ€ç®¡ç† =====
  const startTitleEditing = useCallback(() => {
    if (isEditing) return;
    if (window.electronAPI?.updateFloatingNote && noteData) {
      window.electronAPI.updateFloatingNote(noteData.id, {
        isTitleEditing: true,
      });
    }
    setIsTitleEditing(true);
    setLocalTitle(noteData?.title || "");
  }, [isEditing, noteData]);

  const stopTitleEditing = useCallback(() => {
    if (window.electronAPI?.updateFloatingNote && noteData) {
      window.electronAPI.updateFloatingNote(noteData.id, {
        title: localTitle,
        isTitleEditing: false,
      });
    }
    setIsTitleEditing(false);
  }, [noteData, localTitle]);

  const startEditing = useCallback(() => {
    if (isTitleEditing) return;
    if (window.electronAPI?.updateFloatingNote && noteData) {
      window.electronAPI.updateFloatingNote(noteData.id, {
        isEditing: true,
      });
    }
    setLocalContent(noteData?.content || "");
    setIsEditing(true);
  }, [isTitleEditing, noteData]);

  const stopEditing = useCallback(() => {
    if (window.electronAPI?.updateFloatingNote && noteData) {
      window.electronAPI.updateFloatingNote(noteData.id, {
        content: localContent,
        isEditing: false,
        updatedAt: new Date(),
      });
    }
    setIsEditing(false);
    if (isTitleEditing) {
      stopTitleEditing();
    }
  }, [noteData, localContent, isTitleEditing, stopTitleEditing]);

  // ===== æ¥æ”¶ä¾¿ç­¾æ•°æ®å’Œæ›´æ–° =====
  useEffect(() => {
    const handleNoteData = (_event: any, data: FloatingNoteData) => {
      console.log("æ¥æ”¶åˆ°ä¾¿ç­¾æ•°æ®:", data);
      const note: StickyNoteType = {
        id: data.noteId,
        title: data.title,
        content: data.content,
        color: data.color as any,
        width: data.width,
        height: data.height,
        x: 0,
        y: 0,
        zIndex: 1,
        isEditing: data.isEditing || false,
        isTitleEditing: data.isTitleEditing || false,
        isNew: false,
        createdAt: new Date(),
        updatedAt: new Date(),
      };

      setNoteData(note);
      setLocalTitle(note.title);
      setLocalContent(note.content);
      setIsEditing(data.isEditing || false);
      setIsTitleEditing(data.isTitleEditing || false);
      setIsInitialized(true);
      setIsLoading(false);
    };

    const handleNoteDataUpdated = (_event: any, data: any) => {
      if (data.noteId === noteId) {
        setNoteData((prev: StickyNoteType | null) => {
          if (prev) {
            const updated = { ...prev, ...data };

            if (data.isEditing !== undefined) {
              setIsEditing(data.isEditing);
              if (data.isEditing) {
                setLocalContent(updated.content);
              }
            }

            if (data.isTitleEditing !== undefined) {
              setIsTitleEditing(data.isTitleEditing);
              if (data.isTitleEditing) {
                setLocalTitle(updated.title);
              }
            }

            if (!data.isEditing && !data.isTitleEditing) {
              if (data.title !== undefined) {
                setLocalTitle(updated.title);
              }
              if (data.content !== undefined) {
                setLocalContent(updated.content);
              }
            }

            return updated;
          }
          return null;
        });
      }
    };

    if (window.electronAPI && window.electronAPI.onMenuAction) {
      const removeListener = window.electronAPI.onMenuAction(
        (eventName: string, data: any) => {
          if (eventName === "note-data") {
            handleNoteData(eventName, data);
          } else if (eventName === "note-data-updated") {
            handleNoteDataUpdated(eventName, data);
          }
        }
      );

      // è¶…æ—¶å›é€€ï¼šä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
      const timeout = setTimeout(() => {
        if (noteId && isLoading) {
          const mockNote: StickyNoteType = {
            id: noteId,
            title: "æ‚¬æµ®ä¾¿ç­¾",
            content: "è¿™æ˜¯ä¸€ä¸ªæ‚¬æµ®ä¾¿ç­¾çš„æµ‹è¯•å†…å®¹ã€‚",
            color: "yellow",
            width: 400,
            height: 300,
            x: 0,
            y: 0,
            zIndex: 1,
            isEditing: false,
            isTitleEditing: false,
            isNew: false,
            createdAt: new Date(),
            updatedAt: new Date(),
          };
          setNoteData(mockNote);
          setLocalTitle(mockNote.title);
          setLocalContent(mockNote.content);
          setIsInitialized(true);
          setIsLoading(false);
        }
      }, 1000);

      return () => {
        clearTimeout(timeout);
        removeListener?.();
      };
    }
  }, [noteId, isLoading]);

  // ===== å…³é—­æ‚¬æµ®ä¾¿ç­¾ =====
  const handleClose = useCallback(() => {
    if (noteId && window.electronAPI?.closeFloatingNote) {
      if (noteData && isInitialized) {
        if (localTitle !== noteData.title) {
          window.electronAPI.updateFloatingNote(noteData.id, {
            title: localTitle,
          });
        }
        if (localContent !== noteData.content) {
          window.electronAPI.updateFloatingNote(noteData.id, {
            content: localContent,
          });
        }
        if (isEditing || isTitleEditing) {
          window.electronAPI.updateFloatingNote(noteData.id, {
            isEditing: false,
            isTitleEditing: false,
          });
        }
      }
      window.electronAPI.closeFloatingNote(noteId);
    }
  }, [noteId, noteData, isInitialized, localTitle, localContent, isEditing, isTitleEditing]);

  // ===== æ¸²æŸ“ =====
  if (isLoading || !noteData || !isInitialized) {
    return (
      <div className="floating-window-loading">
        <div className="loading-content">
          {isLoading ? "åŠ è½½ä¸­..." : "ä¾¿ç­¾æ•°æ®åŠ è½½å¤±è´¥"}
        </div>
      </div>
    );
  }

  return (
    <ConfigProvider locale={zhCN}>
      <div className="floating-window">
        <div
          className={`sticky-note color-${noteData.color} ${
            isEditing ? "editing" : ""
          } floating-note-instance`}
          style={{
            position: "relative",
            width: "100%",
            height: "100%",
            display: "flex",
            flexDirection: "column",
          }}
        >
          {/* æ ‡é¢˜æ  - å¯æ‹–æ‹½ */}
          <div className="sticky-note-header">
            <div
              className="drag-handle"
              style={{
                flexGrow: 1,
                display: "flex",
                alignItems: "center",
                minHeight: "20px",
                cursor: "move",
              }}
              title="æ‹–æ‹½ç§»åŠ¨æ‚¬æµ®ä¾¿ç­¾"
            >
              {/* æ ‡é¢˜ç¼–è¾‘å™¨ */}
              {isTitleEditing ? (
                <TitleEditor
                  content={localTitle}
                  onChange={handleTitleChange}
                  onEnter={stopTitleEditing}
                  onEscape={stopTitleEditing}
                  placeholder="ä¾¿ç­¾æ ‡é¢˜..."
                  autoFocus={true}
                  editable={true}
                />
              ) : (
                <h3
                  className="sticky-note-title"
                  onDoubleClick={(e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    if (!isEditing && !isTitleEditing) {
                      startTitleEditing();
                    }
                  }}
                >
                  {localTitle || "ä¾¿ç­¾"}
                </h3>
              )}
            </div>

            {/* å…³é—­æŒ‰é’® */}
            <div className="sticky-note-controls">
              <Button
                icon={<CloseOutlined />}
                onClick={handleClose}
                title="å…³é—­æ‚¬æµ®ä¾¿ç­¾"
                type="text"
                size="small"
                className="close-button sticky-note-close-button"
              />
            </div>
          </div>

          {/* å†…å®¹åŒºåŸŸ */}
          <div className="sticky-note-content">
            <BasicEditor
              content={isEditing ? localContent : noteData.content}
              onChange={handleContentChange}
              onEditorReady={(editor) => {
                setEditorInstance(editor);
                if (isEditing && editor && !editor.isDestroyed) {
                  safeSetTimeout(() => {
                    try {
                      if (editor && !editor.isDestroyed && editor.view) {
                        editor.commands.focus("end");
                      }
                    } catch (error) {
                      console.warn("ç¼–è¾‘å™¨èšç„¦å¤±è´¥:", error);
                    }
                  }, 200);
                }
              }}
              placeholder={isEditing ? "åœ¨è¿™é‡Œç¼–å†™ä¾¿ç­¾å†…å®¹..." : "ç‚¹å‡»ç¼–è¾‘å†…å®¹..."}
              editable={isEditing}
              autoFocus={false}
              showToolbar={false}
              onClick={(e) => {
                if (!isEditing && !isTitleEditing) {
                  e.preventDefault();
                  e.stopPropagation();
                  startEditing();
                }
              }}
              onBlur={() => {
                if (isEditing) {
                  stopEditing();
                }
              }}
              onKeyDown={(event) => {
                if (event.key === "Escape") {
                  if (isEditing) {
                    stopEditing();
                    return true;
                  }
                }
                return false;
              }}
            />
          </div>

          {/* ç¼–è¾‘å·¥å…·æ  */}
          {isEditing && editorInstance && (
            <div className="sticky-note-toolbar-container">
              <BasicToolbar editor={editorInstance} className="basic-editor-toolbar compact" />
            </div>
          )}
        </div>
      </div>
    </ConfigProvider>
  );
};

// æŒ‚è½½ React åº”ç”¨
const root = ReactDOM.createRoot(
  document.getElementById("root") as HTMLElement
);
root.render(<FloatingNote />);

export default FloatingNote;
```

---

### 5. æ‚¬æµ®çª—å£æ ·å¼ (FloatingNote.css)

```css
/* æ‚¬æµ®çª—å£æ•´ä½“æ ·å¼ */
.floating-window {
  width: 100vw;
  height: 100vh;
  overflow: hidden;
  position: relative;
  display: flex;
  flex-direction: column;
  background: #ffffff;
  font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
}

/* â­ å…³é”®ï¼šæ‚¬æµ®çª—å£æ‹–æ‹½åŒºåŸŸ */
.floating-drag-area {
  height: 30px;
  background: rgba(0, 0, 0, 0.03);
  -webkit-app-region: drag;  /* å¯ç”¨æ‹–æ‹½ */
  display: flex;
  align-items: center;
  justify-content: flex-end;
  padding: 0 12px;
  border-bottom: 1px solid rgba(0, 0, 0, 0.06);
  flex-shrink: 0;
  z-index: 10;
  user-select: none;
}

/* å…³é—­æŒ‰é’® */
.floating-close-button {
  -webkit-app-region: no-drag;  /* ç¦ç”¨æ‹–æ‹½ */
  background: #ff5f56;
  border: none;
  border-radius: 50%;
  width: 18px;
  height: 18px;
  color: white;
  font-size: 12px;
  cursor: pointer;
  transition: background-color 0.2s ease;
}

.floating-close-button:hover {
  background: #ff3b30;
}

/* â­ å…³é”®ï¼šæ‚¬æµ®ä¾¿ç­¾å¤´éƒ¨æ‹–æ‹½åŠŸèƒ½ */
.floating-note-instance .drag-handle {
  -webkit-app-region: drag;  /* å¯ç”¨æ‹–æ‹½ */
}

/* æ ‡é¢˜å’Œæ§åˆ¶æŒ‰é’®ç¦ç”¨æ‹–æ‹½ */
.floating-note-instance .sticky-note-title,
.floating-note-instance .sticky-note-title-editor,
.floating-note-instance .sticky-note-controls,
.floating-note-instance .close-button {
  -webkit-app-region: no-drag;  /* ç¦ç”¨æ‹–æ‹½ */
}

/* æ‚¬æµ®ä¾¿ç­¾æ§åˆ¶æŒ‰é’®å§‹ç»ˆæ˜¾ç¤º */
.floating-note-instance .sticky-note-controls {
  opacity: 1 !important;
}

/* æ‚¬æµ®ä¾¿ç­¾æ ·å¼è°ƒæ•´ */
.sticky-note.floating-note-instance {
  position: static !important;
  left: auto !important;
  top: auto !important;
  width: 100% !important;
  height: 100% !important;
  box-shadow: none !important;
  border: none !important;
  border-radius: 0 !important;
  min-width: unset !important;
  min-height: unset !important;
  max-width: none !important;
  max-height: none !important;
  flex: 1;
}

/* åŠ è½½å’Œé”™è¯¯çŠ¶æ€ */
.floating-window-loading {
  width: 100vw;
  height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #ffffff;
}

.loading-content {
  font-size: 14px;
  color: #666;
}

.error-content {
  font-size: 14px;
  color: #f5222d;
}
```

---

### 6. ä¸»çª—å£ä¾¿ç­¾ç»„ä»¶ä¸­çš„è§¦å‘é€»è¾‘ (StickyNote.tsx)

```typescript
// å¤„ç†æ‚¬æµ®ä¾¿ç­¾æŒ‰é’®ç‚¹å‡»
const handleFloatingNote = useCallback(async () => {
  try {
    // æ£€æŸ¥æ˜¯å¦åœ¨ Electron ç¯å¢ƒä¸­
    if (window.electronAPI && window.electronAPI.createFloatingNote) {
      // åˆ›å»ºæ‚¬æµ®çª—å£ï¼Œä¼ é€’ä¾¿ç­¾æ•°æ®åŠç¼–è¾‘çŠ¶æ€
      const result = await window.electronAPI.createFloatingNote({
        noteId: note.id,
        title: note.title,
        content: jsonToText(note.content),  // å°† JSON è½¬ä¸ºçº¯æ–‡æœ¬
        color: note.color,
        width: note.width,
        height: note.height,
        isEditing: note.isEditing,
        isTitleEditing: note.isTitleEditing,
      });

      if (result.success) {
        message.success("ä¾¿ç­¾å·²è®¾ä¸ºæ‚¬æµ®æ˜¾ç¤º");
      } else {
        message.error("åˆ›å»ºæ‚¬æµ®ä¾¿ç­¾å¤±è´¥: " + (result.error || "æœªçŸ¥é”™è¯¯"));
      }
    } else {
      message.warning("æ‚¬æµ®åŠŸèƒ½ä»…åœ¨æ¡Œé¢åº”ç”¨ä¸­å¯ç”¨");
    }
  } catch (error) {
    console.error("åˆ›å»ºæ‚¬æµ®ä¾¿ç­¾å¤±è´¥:", error);
    message.error("åˆ›å»ºæ‚¬æµ®ä¾¿ç­¾å¤±è´¥");
  }
}, [note]);

// åœ¨ä¾¿ç­¾å·¥å…·æ ä¸­æ·»åŠ æ‚¬æµ®æŒ‰é’®
<Tooltip title="æ‚¬æµ®æ˜¾ç¤º">
  <Button
    type="text"
    size="small"
    icon={<PushpinOutlined />}
    onClick={(e) => {
      e.stopPropagation();
      handleFloatingNote();
    }}
  />
</Tooltip>
```

---

### 7. ä¸»çª—å£ä¸­çš„æ•°æ®åŒæ­¥ (App.tsx)

```typescript
// ç›‘å¬æ‚¬æµ®ä¾¿ç­¾çš„æ›´æ–°äº‹ä»¶
useEffect(() => {
  if (window.electronAPI?.onMenuAction && appInitialized) {
    console.log("ğŸ“ æ³¨å†Œæ‚¬æµ®ä¾¿ç­¾çŠ¶æ€åŒæ­¥ç›‘å¬å™¨");

    const removeListener = window.electronAPI.onMenuAction(
      (eventName, data) => {
        // å¤„ç†æ‚¬æµ®ä¾¿ç­¾å‘ä¸»çª—å£çš„æ›´æ–°
        if (eventName === "floating-note-updated" && data?.noteId) {
          console.log("ğŸ“ æ”¶åˆ°æ‚¬æµ®ä¾¿ç­¾æ›´æ–°:", data);

          const { noteId, updates } = data;
          if (noteId && updates) {
            // æ›´æ–° Zustand store ä¸­çš„ä¾¿ç­¾æ•°æ®
            updateNote(noteId, updates);
          }
        }
      }
    );

    return () => {
      removeListener?.();
    };
  }
}, [appInitialized, updateNote]);
```

---

## å…³é”®æŠ€æœ¯ç‚¹

### 1. æ— è¾¹æ¡†çª—å£å®ç°

**é—®é¢˜**ï¼šé»˜è®¤çš„ Electron çª—å£æœ‰ç³»ç»Ÿæ ‡é¢˜æ ï¼Œä¸å¤Ÿç¾è§‚ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
```javascript
const floatingWindow = new BrowserWindow({
  frame: false,        // ç§»é™¤è¾¹æ¡†
  transparent: true,   // é€æ˜èƒŒæ™¯
  // ...
});
```

**æ³¨æ„äº‹é¡¹**ï¼š
- éœ€è¦è‡ªå·±å®ç°æ‹–æ‹½åŠŸèƒ½
- éœ€è¦è‡ªå·±å®ç°å…³é—­æŒ‰é’®
- macOS å’Œ Windows è¡¨ç°å¯èƒ½ä¸åŒ

---

### 2. çª—å£æ‹–æ‹½åŠŸèƒ½

**CSS å®ç°**ï¼š
```css
/* å¯ç”¨æ‹–æ‹½çš„åŒºåŸŸ */
.drag-handle {
  -webkit-app-region: drag;
}

/* ç¦ç”¨æ‹–æ‹½çš„åŒºåŸŸï¼ˆå¦‚æŒ‰é’®ï¼‰ */
.close-button {
  -webkit-app-region: no-drag;
}
```

**å…³é”®ç‚¹**ï¼š
- `-webkit-app-region: drag` å¯ç”¨æ‹–æ‹½
- `-webkit-app-region: no-drag` ç¦ç”¨æ‹–æ‹½
- éœ€è¦åœ¨æ— è¾¹æ¡†çª—å£ä¸­ä½¿ç”¨
- æŒ‰é’®ç­‰äº¤äº’å…ƒç´ å¿…é¡»è®¾ç½®ä¸º `no-drag`

---

### 3. åŒå‘æ•°æ®åŒæ­¥

**åŒæ­¥æµç¨‹**ï¼š

```
æ‚¬æµ®çª—å£ç¼–è¾‘
    â†“
updateFloatingNote(noteId, updates)
    â†“
IPC â†’ ä¸»è¿›ç¨‹
    â†“
å‘é€åˆ°ä¸»çª—å£: floating-note-updated
    â†“
ä¸»çª—å£æ›´æ–° Zustand Store
    â†“
æ•°æ®åº“ä¿å­˜

ä¸»çª—å£ç¼–è¾‘
    â†“
updateNote(noteId, updates)
    â†“
æ•°æ®åº“ä¿å­˜
    â†“
ï¼ˆå¯é€‰ï¼‰é€šçŸ¥æ‚¬æµ®çª—å£åˆ·æ–°
```

**å®ç°ä»£ç **ï¼š
```javascript
// ä¸»è¿›ç¨‹
ipcMain.handle("update-floating-note", (event, noteId, updates) => {
  const window = floatingWindows.get(noteId);
  
  // æ›´æ–°æ‚¬æµ®çª—å£
  if (window && !window.isDestroyed()) {
    window.webContents.send("note-data-updated", { noteId, ...updates });
  }

  // é€šçŸ¥ä¸»çª—å£
  if (mainWindow && !mainWindow.isDestroyed()) {
    mainWindow.webContents.send("floating-note-updated", {
      noteId,
      updates,
    });
  }
});
```

---

### 4. çª—å£ç”Ÿå‘½å‘¨æœŸç®¡ç†

**å…³é”®ç‚¹**ï¼š
1. **åˆ›å»ºå‰æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨**
   ```javascript
   if (floatingWindows.has(noteId)) {
     const existingWindow = floatingWindows.get(noteId);
     if (!existingWindow.isDestroyed()) {
       existingWindow.focus();
       return;
     }
   }
   ```

2. **å»¶è¿Ÿæ˜¾ç¤ºçª—å£**
   ```javascript
   const floatingWindow = new BrowserWindow({
     show: false,  // å…ˆä¸æ˜¾ç¤º
     // ...
   });

   floatingWindow.once("ready-to-show", () => {
     floatingWindow.show();
   });
   ```

3. **æ¸…ç†èµ„æº**
   ```javascript
   floatingWindow.on("closed", () => {
     floatingWindows.delete(noteId);
   });
   ```

---

### 5. é˜²æ­¢å†…å­˜æ³„æ¼

**å®šæ—¶å™¨æ¸…ç†**ï¼š
```typescript
const timersRef = useRef<Set<NodeJS.Timeout>>(new Set());

const safeSetTimeout = useCallback((callback: () => void, delay: number) => {
  const timer = setTimeout(() => {
    timersRef.current.delete(timer);
    callback();
  }, delay);
  timersRef.current.add(timer);
  return timer;
}, []);

useEffect(() => {
  return () => {
    // ç»„ä»¶å¸è½½æ—¶æ¸…ç†æ‰€æœ‰å®šæ—¶å™¨
    timersRef.current.forEach((timer) => clearTimeout(timer));
    timersRef.current.clear();
  };
}, []);
```

**äº‹ä»¶ç›‘å¬å™¨æ¸…ç†**ï¼š
```typescript
useEffect(() => {
  const removeListener = window.electronAPI.onMenuAction(callback);
  
  return () => {
    removeListener?.();  // æ¸…ç†ç›‘å¬å™¨
  };
}, []);
```

---

### 6. è·¨å¹³å°å…¼å®¹æ€§

**å¹³å°æ£€æµ‹**ï¼š
```javascript
// preload.cjs
contextBridge.exposeInMainWorld("electronAPI", {
  platform: process.platform,  // 'darwin', 'win32', 'linux'
  // ...
});
```

**å¹³å°ç‰¹å®šæ ·å¼**ï¼š
```css
/* macOS */
.platform-darwin .close-button {
  background: #ff5f56;  /* çº¢è‰² */
}

/* Windows */
.platform-win32 .close-button {
  background: #e81123;  /* å¾®è½¯çº¢ */
}
```

---

## æ•°æ®æµè®¾è®¡

### å®Œæ•´æ•°æ®æµå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ç”¨æˆ·æ“ä½œï¼šç‚¹å‡»"æ‚¬æµ®"æŒ‰é’®                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     ä¸»çª—å£ Renderer Process (StickyNote.tsx)                â”‚
â”‚     handleFloatingNote()                                    â”‚
â”‚     â†’ window.electronAPI.createFloatingNote(noteData)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“ IPC Invoke
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Preload Script (preload.cjs)                            â”‚
â”‚     â†’ ipcRenderer.invoke("create-floating-note", noteData)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“ IPC
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Main Process (main.cjs)                                 â”‚
â”‚     ipcMain.handle("create-floating-note")                  â”‚
â”‚     â†’ createFloatingNoteWindow(noteData)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     åˆ›å»ºæ–°çš„ BrowserWindow                                   â”‚
â”‚     - frame: false                                          â”‚
â”‚     - transparent: true                                     â”‚
â”‚     - alwaysOnTop: true                                     â”‚
â”‚     â†’ loadURL('floating.html?noteId=xxx')                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Floating Window Renderer Process (FloatingNote.tsx)     â”‚
â”‚     - è§£æ URL å‚æ•°è·å– noteId                               â”‚
â”‚     - ç›‘å¬ 'note-data' äº‹ä»¶                                  â”‚
â”‚     - æ¥æ”¶å¹¶æ˜¾ç¤ºä¾¿ç­¾æ•°æ®                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Main Process å‘é€æ•°æ®                                    â”‚
â”‚     floatingWindow.webContents.send("note-data", noteData)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Floating Window æ¸²æŸ“ä¾¿ç­¾                                 â”‚
â”‚     - æ˜¾ç¤ºæ ‡é¢˜å’Œå†…å®¹                                          â”‚
â”‚     - æ”¯æŒç¼–è¾‘                                               â”‚
â”‚     - ç›‘å¬ç”¨æˆ·äº¤äº’                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç¼–è¾‘åŒæ­¥æ•°æ®æµ

```
æ‚¬æµ®çª—å£ç”¨æˆ·ç¼–è¾‘å†…å®¹
    â†“
handleContentChange(newContent)
    â†“
é˜²æŠ– 300ms
    â†“
window.electronAPI.updateFloatingNote(noteId, { content })
    â†“ IPC
Main Process: ipcMain.handle("update-floating-note")
    â†“
å‘é€åˆ°ä¸»çª—å£: mainWindow.webContents.send("floating-note-updated")
    â†“
ä¸»çª—å£: window.electronAPI.onMenuAction("floating-note-updated")
    â†“
updateNote(noteId, updates)  // Zustand Store
    â†“
æ•°æ®åº“ä¿å­˜ (IndexedDB)
```

---

## å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### 1. çª—å£æ— æ³•æ‹–æ‹½

**é—®é¢˜**ï¼šè®¾ç½®äº† `-webkit-app-region: drag` ä½†çª—å£æ— æ³•æ‹–æ‹½ã€‚

**åŸå› **ï¼š
- æ²¡æœ‰è®¾ç½® `frame: false`
- æ‹–æ‹½åŒºåŸŸè¢«å…¶ä»–å…ƒç´ è¦†ç›–
- CSS ä¼˜å…ˆçº§é—®é¢˜

**è§£å†³æ–¹æ¡ˆ**ï¼š
```css
/* ç¡®ä¿æ‹–æ‹½åŒºåŸŸçš„ z-index è¶³å¤Ÿé«˜ */
.drag-handle {
  -webkit-app-region: drag;
  z-index: 1000;
  position: relative;
}

/* ç¡®ä¿å­å…ƒç´ ä¸é˜»æ­¢æ‹–æ‹½ */
.drag-handle * {
  pointer-events: none;
}

/* éœ€è¦äº¤äº’çš„å…ƒç´ å•ç‹¬è®¾ç½® */
.drag-handle .interactive-element {
  pointer-events: auto;
  -webkit-app-region: no-drag;
}
```

---

### 2. æ•°æ®ä¸åŒæ­¥

**é—®é¢˜**ï¼šæ‚¬æµ®çª—å£å’Œä¸»çª—å£çš„æ•°æ®ä¸ä¸€è‡´ã€‚

**åŸå› **ï¼š
- IPC é€šä¿¡å¤±è´¥
- äº‹ä»¶ç›‘å¬å™¨æœªæ­£ç¡®æ³¨å†Œ
- çŠ¶æ€æ›´æ–°æ—¶æœºé—®é¢˜

**è§£å†³æ–¹æ¡ˆ**ï¼š
```typescript
// 1. ç¡®ä¿äº‹ä»¶ç›‘å¬å™¨æ­£ç¡®æ³¨å†Œ
useEffect(() => {
  if (!window.electronAPI?.onMenuAction) return;

  const removeListener = window.electronAPI.onMenuAction(
    (eventName, data) => {
      if (eventName === "floating-note-updated") {
        console.log("æ”¶åˆ°æ›´æ–°:", data);  // æ·»åŠ æ—¥å¿—
        updateNote(data.noteId, data.updates);
      }
    }
  );

  return () => {
    removeListener?.();
  };
}, [updateNote]);

// 2. ä¸»è¿›ç¨‹ç¡®ä¿æ¶ˆæ¯å‘é€
ipcMain.handle("update-floating-note", (event, noteId, updates) => {
  console.log("ä¸»è¿›ç¨‹æ”¶åˆ°æ›´æ–°è¯·æ±‚:", noteId, updates);  // æ·»åŠ æ—¥å¿—
  
  if (mainWindow && !mainWindow.isDestroyed()) {
    console.log("å‘é€æ›´æ–°åˆ°ä¸»çª—å£");
    mainWindow.webContents.send("floating-note-updated", {
      noteId,
      updates,
    });
  }
});
```

---

### 3. çª—å£é€æ˜åº¦é—®é¢˜

**é—®é¢˜**ï¼šçª—å£èƒŒæ™¯ä¸é€æ˜æˆ–æ˜¾ç¤ºé»‘è‰²ã€‚

**åŸå› **ï¼š
- æ²¡æœ‰è®¾ç½® `transparent: true`
- CSS èƒŒæ™¯è‰²è®¾ç½®é—®é¢˜
- å¹³å°å…¼å®¹æ€§é—®é¢˜

**è§£å†³æ–¹æ¡ˆ**ï¼š
```javascript
// 1. ç¡®ä¿çª—å£é…ç½®æ­£ç¡®
const floatingWindow = new BrowserWindow({
  transparent: true,
  backgroundColor: undefined,  // ä¸è®¾ç½®èƒŒæ™¯è‰²
  // ...
});
```

```css
/* 2. CSS è®¾ç½®é€æ˜èƒŒæ™¯ */
html, body {
  background: transparent;
}

.floating-window {
  background: transparent;
}

.sticky-note {
  background: rgba(255, 255, 255, 0.95);  /* åŠé€æ˜ç™½è‰² */
}
```

---

### 4. å†…å­˜æ³„æ¼

**é—®é¢˜**ï¼šé•¿æ—¶é—´è¿è¡Œåå†…å­˜å ç”¨è¿‡é«˜ã€‚

**åŸå› **ï¼š
- å®šæ—¶å™¨æœªæ¸…ç†
- äº‹ä»¶ç›‘å¬å™¨æœªç§»é™¤
- çª—å£å¼•ç”¨æœªé‡Šæ”¾

**è§£å†³æ–¹æ¡ˆ**ï¼š
```typescript
// 1. æ¸…ç†å®šæ—¶å™¨
useEffect(() => {
  const timer = setTimeout(() => {}, 1000);
  return () => clearTimeout(timer);
}, []);

// 2. æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
useEffect(() => {
  const removeListener = window.electronAPI.onMenuAction(callback);
  return () => removeListener?.();
}, []);

// 3. ä¸»è¿›ç¨‹æ¸…ç†çª—å£å¼•ç”¨
floatingWindow.on("closed", () => {
  floatingWindows.delete(noteId);
  floatingWindow = null;  // é‡Šæ”¾å¼•ç”¨
});
```

---

### 5. çª—å£ä½ç½®å’Œå¤§å°ä¿å­˜

**é—®é¢˜**ï¼šå…³é—­æ‚¬æµ®çª—å£åï¼Œå†æ¬¡æ‰“å¼€ä½ç½®å’Œå¤§å°ä¸ä¸€è‡´ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
```javascript
// 1. ç›‘å¬çª—å£ä½ç½®å’Œå¤§å°å˜åŒ–
floatingWindow.on("moved", () => {
  const bounds = floatingWindow.getBounds();
  // ä¿å­˜ä½ç½®åˆ°æ•°æ®åº“æˆ–é…ç½®æ–‡ä»¶
  saveWindowPosition(noteId, bounds);
});

floatingWindow.on("resized", () => {
  const bounds = floatingWindow.getBounds();
  // ä¿å­˜å¤§å°åˆ°æ•°æ®åº“æˆ–é…ç½®æ–‡ä»¶
  saveWindowSize(noteId, bounds);
});

// 2. åˆ›å»ºçª—å£æ—¶æ¢å¤ä½ç½®å’Œå¤§å°
const savedBounds = loadWindowBounds(noteId);
const floatingWindow = new BrowserWindow({
  x: savedBounds?.x,
  y: savedBounds?.y,
  width: savedBounds?.width || 400,
  height: savedBounds?.height || 300,
  // ...
});
```

---

## æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **æ¶æ„è®¾è®¡**
   - ä¸»è¿›ç¨‹ç®¡ç†çª—å£ç”Ÿå‘½å‘¨æœŸ
   - Preload è„šæœ¬æä¾›å®‰å…¨çš„ API
   - æ¸²æŸ“è¿›ç¨‹è´Ÿè´£ UI å’Œäº¤äº’

2. **çª—å£ç‰¹æ€§**
   - `frame: false` + `transparent: true` å®ç°æ— è¾¹æ¡†é€æ˜çª—å£
   - `-webkit-app-region: drag` å®ç°æ‹–æ‹½åŠŸèƒ½
   - `alwaysOnTop: true` ä¿æŒçª—å£ç½®é¡¶

3. **æ•°æ®åŒæ­¥**
   - IPC é€šä¿¡å®ç°åŒå‘æ•°æ®åŒæ­¥
   - é˜²æŠ–ä¼˜åŒ–å‡å°‘é€šä¿¡é¢‘ç‡
   - äº‹ä»¶ç›‘å¬å™¨ç¡®ä¿çŠ¶æ€ä¸€è‡´

4. **æ€§èƒ½ä¼˜åŒ–**
   - å»¶è¿Ÿæ˜¾ç¤ºçª—å£ (`show: false`)
   - åŠæ—¶æ¸…ç†èµ„æºï¼ˆå®šæ—¶å™¨ã€ç›‘å¬å™¨ã€çª—å£å¼•ç”¨ï¼‰
   - ä½¿ç”¨ Map ç®¡ç†å¤šä¸ªçª—å£å®ä¾‹

5. **ç”¨æˆ·ä½“éªŒ**
   - æ”¯æŒç¼–è¾‘æ ‡é¢˜å’Œå†…å®¹
   - æä¾›ç¼–è¾‘å·¥å…·æ 
   - ä¼˜é›…çš„åŠ è½½å’Œé”™è¯¯çŠ¶æ€

### é€‚ç”¨åœºæ™¯

è¿™ä¸ªå®ç°æ–¹æ¡ˆé€‚ç”¨äºï¼š
- éœ€è¦æ‚¬æµ®æ˜¾ç¤ºå†…å®¹çš„æ¡Œé¢åº”ç”¨
- ç¬”è®°ã€å¾…åŠã€æé†’ç±»åº”ç”¨
- éœ€è¦å¤šçª—å£ç®¡ç†çš„åœºæ™¯
- è·¨å¹³å°æ¡Œé¢åº”ç”¨å¼€å‘

### æ‰©å±•å»ºè®®

1. **å¢å¼ºåŠŸèƒ½**
   - æ”¯æŒçª—å£å¸é™„è¾¹ç¼˜
   - æ”¯æŒé€æ˜åº¦è°ƒèŠ‚
   - æ”¯æŒå¿«æ·é”®æ“ä½œ

2. **æ€§èƒ½ä¼˜åŒ–**
   - è™šæ‹ŸåŒ–é•¿åˆ—è¡¨å†…å®¹
   - å›¾ç‰‡æ‡’åŠ è½½
   - èŠ‚æµçª—å£å¤§å°å˜åŒ–äº‹ä»¶

3. **ç”¨æˆ·ä½“éªŒ**
   - æ·»åŠ çª—å£åŠ¨ç”»æ•ˆæœ
   - æ”¯æŒä¸»é¢˜åˆ‡æ¢
   - æä¾›æ›´å¤šè‡ªå®šä¹‰é€‰é¡¹

---

## é™„å½•ï¼šå®Œæ•´æ–‡ä»¶æ¸…å•

### å¿…éœ€æ–‡ä»¶
1. `electron/main.cjs` - ä¸»è¿›ç¨‹é€»è¾‘
2. `electron/preload.cjs` - Preload è„šæœ¬
3. `floating.html` - æ‚¬æµ®çª—å£ HTML
4. `src/pages/FloatingNote.tsx` - æ‚¬æµ®çª—å£ React ç»„ä»¶
5. `src/pages/FloatingNote.css` - æ‚¬æµ®çª—å£æ ·å¼
6. `src/components/notes/StickyNote.tsx` - ä¸»çª—å£ä¾¿ç­¾ç»„ä»¶ï¼ˆè§¦å‘æ‚¬æµ®ï¼‰
7. `src/App.tsx` - ä¸»åº”ç”¨ï¼ˆæ•°æ®åŒæ­¥ï¼‰
8. `src/types/electron.d.ts` - TypeScript ç±»å‹å®šä¹‰

### é…ç½®æ–‡ä»¶
1. `package.json` - ä¾èµ–å’Œæ„å»ºè„šæœ¬
2. `vite.config.ts` - Vite é…ç½®ï¼ˆå¤šå…¥å£ï¼‰

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2025-10-12  
**ä½œè€…**: Infinity Notes å¼€å‘å›¢é˜Ÿ  
**è®¸å¯**: MIT License
