# Infinity Notes AI 多供应商设置复刻指南

## 背景与目标

- 目的：梳理 Infinity Notes 项目中 AI 设置相关功能，方便在其他项目快速复刻多家供应商对接与统一参数配置能力。
- 关键诉求：支持多供应商账号切换、参数统一校验、配置持久化、事件同步以及运行时的跨供应商适配。

## 架构总览

```
设置界面 (SettingsModal / AISettingsForm / ProviderSelector)
  ↓ 用户交互
useAISettings Hook ＋ AIConfigManager (事件总线)
  ↓ 状态同步
IndexedDBAISettingsStorage ＋ IndexedDBAIProviderStorage (持久化)
  ↓ 配置下发
useAIStore / AIService (统一 API 调用层) → 业务功能 (生成便签、AI分析)
```

- `src/components/modals/SettingsModal.tsx`：聚合设置面板，控制供应商选择、模型选择、参数编辑和连接测试。
- `src/hooks/ai/useAISettings.ts`：管理 AI 基础配置的加载、保存、测试，与 `AIConfigManager` 和 `AIService` 协作。
- `src/utils/aiConfigManager.ts`：单例事件枢纽，负责广播配置更新并驱动其他订阅方同步状态。
- `src/services/ai/aiService.ts`：统一的 AI 调用层，封装预连接、流式响应、思维链解析及供应商差异化处理。
- `src/database/IndexedDBAISettingsStorage.ts` 与 `IndexedDBAIProviderStorage.ts`：持久化当前全局配置及各供应商私有配置。

## 核心数据结构

| 结构                     | 位置                           | 说明                                                                              |
| ------------------------ | ------------------------------ | --------------------------------------------------------------------------------- |
| `AIConfig`               | `src/services/ai/aiService.ts` | 统一的运行时配置（API URL、Key、模型、temperature、maxTokens、systemPrompt 等）。 |
| `AIProvider` / `AIModel` | `src/types/aiProviders.ts`     | 供应商及模型的元数据定义，支持分类、上下文长度、定价信息。                        |
| `AI_PROVIDERS`           | `src/types/aiProviders.ts`     | 预设供应商列表，提供 UI 展示和默认 API 地址。                                     |
| `AIConfigUpdateEvent`    | `src/types/ai.ts`              | 统一的配置更新事件载荷，标记更新来源。                                            |

统一使用 `AIConfig` 作为跨模块的契约，保证 UI、存储、Service 层之间的数据结构一致性。

## 配置生命周期

1. **加载**：`useAISettings` 在挂载时通过 `IndexedDBAISettingsStorage.loadConfig()` 读取当前配置，并注入 `AIService`。
2. **编辑**：用户在 `SettingsModal` 中修改参数，并可通过 `AISettingsForm` 实时验证 (`AIConfigValidator`)。
3. **保存**：`useAISettings.saveConfig()` 写入 IndexedDB，同时调用 `AIConfigManager.notifyConfigUpdate()` 触发全局同步。
4. **同步**：
   - `AIConfigManager` 将更新广播给订阅方（如其他 Hook、Store、提示词模块）。
   - `useAIStore` 监听 `ai-config-updated` 自定义事件，保证 Zustand 状态与最新配置一致。
5. **运行时**：`getAIService(config)` 依据新配置更新或重建 `AIService` 单例，后续生成便签、测试连接都复用统一接口。

## 多供应商适配策略

### 1. 供应商注册表

- `AI_PROVIDERS` 聚合 OpenAI、DeepSeek、Anthropic、阿里云百炼、百度文心智谱等多个供应商。
- 每个条目包含 API 基础 URL、模型列表、描述、文档链接，供 UI 和逻辑复用。

### 2. UI 选择与自动识别

- `AIProviderSelector` (`src/components/ai/AIProviderSelector.tsx`)：卡片式选择器展示供应商信息、配置状态、热门标签，并支持自定义选项。
- `SettingsModal` 打开时会根据当前 `AIConfig.apiUrl` 自动匹配供应商（`isProviderAutoDetected` 标记防止重复覆盖用户选择）。
- `AIModelSelector` (`src/components/ai/AIModelSelector.tsx`) 根据供应商动态列出模型，支持分类、搜索、价格/上下文信息展示。

### 3. 供应商私有配置快照

- 切换供应商时，`SettingsModal` 会调用 `IndexedDBAIProviderStorage.saveProviderConfig()` 存储该供应商的 API URL、密钥、模型及高级参数。
- 下次返回同一供应商会自动回填上次配置，实现“一次配置，多次切换无需重填”。
- 自定义供应商使用 `providerId = "custom"` 单独存档，兼容任何 OpenAI 接口协议的服务商。

### 4. 统一的 API 调用协议

- `AIService` 默认拼接 `{config.apiUrl}/chat/completions` 发送兼容 OpenAI 的请求格式。
- 针对阿里云百炼等供应商，内置启停 `enable_thinking` 等特定字段，确保思维链模式/非流式调用都符合供应商要求。
- 预连接、连接测试、流式输出共用统一的构造逻辑，仅根据配置差异化调整参数。

## 参数统一与校验

- `AIConfigValidator` (`src/utils/aiValidation.ts`) 校验 API Key、URL、模型、温度、Token 上限、总结模式等字段，提供错误与警告列表。
- `AIConfigStatus` 组件以进度条、标签形式反馈配置完整度，避免未配置即调用导致的错误。
- `AISettingsForm` 中使用 Ant Design `Form` + 自定义 `validator` 实现实时校验与 UI 反馈。

## 存储与同步机制

- **全局配置**：`IndexedDBAISettingsStorage`
  - 以固定 ID `ai-settings` 持久化当前生效的 `AIConfig`。
  - API Key 经简单加密（XOR + Base64）存储，加载时解密。
  - 支持从旧版 localStorage 迁移。
- **多供应商配置**：`IndexedDBAIProviderStorage`
  - 表 `ai_provider_configs` 按 `providerId` 保存每家供应商的专属配置快照。
  - API Key 使用 Base64 混淆保存。
  - 提供批量加载（`loadAllProviderConfigs`）供 UI 显示配置状态。
- **事件通知**：
  - `AIConfigManager.notifyConfigUpdate()` 将配置变更派发为 `window` 上的 `CustomEvent("ai-config-updated")`。
  - `useAIStore` 在浏览器环境下监听该事件，保持 Zustand 状态同步且避免循环更新。

## 复刻步骤建议

1. **抽象契约**：在新项目中复用或改写 `AIConfig`、`AIProvider`、`AIModel` 类型，统一参数命名。
2. **建立供应商目录**：复制/裁剪 `AI_PROVIDERS`，并根据项目需求补充模型定义。
3. **搭建存储层**：
   - 实现全局配置存储（可选 IndexedDB、本地文件或服务端接口）。
   - 如果需要供应商切换，复用 `IndexedDBAIProviderStorage` 的多快照思路。
4. **配置管理 Hook**：
   - 引入 `useAISettings`（或等效逻辑）处理加载/保存/测试。
   - 保留事件总线 `AIConfigManager`，便于多个界面与服务共享状态。
5. **界面层集成**：
   - 使用 `AIProviderSelector` + `AIModelSelector` + `AISettingsForm` 组合完整的设置页。
   - 在保存前调用 `AIConfigValidator.validateConfig()` 并给出 UI 反馈。
6. **服务层适配**：
   - 以 `AIService` 为基础处理请求构造、流式解析、思维链拆分。
   - 根据目标供应商差异，扩展条件逻辑（例如特殊 headers、路径或参数）。
7. **事件与 Store 对接**：
   - 需要全局访问时，可接入 Zustand/Redux，监听 `ai-config-updated` 保持同步。
8. **连接测试 & 回归**：
   - 复用 `AIService.testConnection()` / `testThinkingChain()` 让用户即时验证配置可用性。

## 注意事项与扩展建议

- **密钥安全**：当前示例仅做轻量混淆，生产环境建议放到安全后端或使用更强的加密方案。
- **接口兼容性**：如果目标供应商不遵循 OpenAI 接口，需要在 `AIService` 中新增适配器层，将统一的 `AIConfig` 转换为供应商的请求格式。
- **思维链功能**：`AIService` 内置 `<thinking>`/`<think>` 标签解析和流式展示逻辑，复制功能时可一并迁移。
- **UI 扩展**：`SettingsModal` 中还集成了提示词模板（`useAIPromptSettings`）、外观设置、数据管理等模块，可按需裁剪。

---

如需进一步深入，可参考以下关键文件：

- `src/services/ai/aiService.ts`
- `src/hooks/ai/useAISettings.ts`
- `src/utils/aiConfigManager.ts`
- `src/utils/aiValidation.ts`
- `src/components/modals/SettingsModal.tsx`
- `src/components/ai/AIProviderSelector.tsx`
- `src/database/IndexedDBAISettingsStorage.ts`
- `src/database/IndexedDBAIProviderStorage.ts`
