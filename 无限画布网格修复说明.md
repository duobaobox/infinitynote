# 无限画布网格修复说明

## 📋 问题描述

之前的画布背景网格使用固定尺寸（4000x4000px），导致拖动画布一段距离后就会看到明显的边界。

## ✅ 修复方案

### 1. 扩大网格尺寸

将网格背景的尺寸从 4000x4000px 扩大到 100000x100000px，并相应调整定位：

```css
/* 修改前 */
.grid {
  position: absolute;
  top: -2000px;
  left: -2000px;
  width: 4000px;
  height: 4000px;
}

/* 修改后 */
.grid {
  position: absolute;
  top: -50000px;
  left: -50000px;
  width: 100000px;
  height: 100000px;
}
```

### 2. 优化网格渲染结构

将网格从 `canvasContent` 容器内移到外面，作为独立层渲染：

**优点：**

- 网格和便签内容解耦
- 性能更好（独立的渲染层）
- 更容易控制网格的显示/隐藏

```tsx
{/* 网格背景层 - 独立渲染 */}
{displaySettings.showGrid && (
  <div className={`${styles.grid} grid`} style={{...}} />
)}

{/* 便签内容层 */}
<DndContext>
  <div className={`${styles.canvasContent} canvasContent`}>
    <VirtualizedNoteContainer ... />
  </div>
</DndContext>
```

### 3. 网格跟随画布移动

网格应用相同的 transform，确保与画布内容同步移动和缩放：

```tsx
style={{
  transform: `translate3d(${finalOffset.x}px, ${finalOffset.y}px, 0) scale(${viewport.scale})`,
  backgroundSize: `${gridTheme.gridSize}px ${gridTheme.gridSize}px`,
}}
```

## 📐 技术细节

### 为什么选择 100000px？

1. **覆盖范围计算：**

   - 中心点：(50000, 50000)
   - 可向任意方向平移 ±50000px
   - 在 1:1 缩放下，相当于 50000 像素的移动空间
   - 在 0.25 缩放下，视觉上相当于 200000 像素的空间

2. **用户使用场景：**

   - 一般用户很少会拖动超过几千像素
   - 100000px 提供了足够的"无限"感觉
   - 不会造成明显的性能问题

3. **性能考虑：**
   - CSS 背景图案是重复渲染的，不是一次性绘制整个区域
   - `background-size` 控制单个网格单元的大小（20px）
   - 浏览器只渲染可见区域的网格，不会渲染整个 100000px

### 性能优化

```css
.grid {
  /* 启用硬件加速 */
  will-change: transform;
  backface-visibility: hidden;
  /* 禁用鼠标事件，避免干扰便签操作 */
  pointer-events: none;
}
```

## 🧪 测试方法

1. **启动开发服务器：**

   ```bash
   npm run dev
   ```

2. **访问应用：**
   打开 http://localhost:5173/

3. **测试网格边界：**

   - 按住鼠标中键（或 Ctrl+左键）拖动画布
   - 尝试向各个方向拖动较大距离
   - 观察网格是否始终保持连续，无边界出现

4. **测试缩放：**

   - 使用 Ctrl+滚轮缩放画布
   - 检查网格是否正确缩放
   - 网格间距应该随缩放比例变化

5. **测试性能：**
   - 快速拖动画布
   - 观察是否有卡顿
   - 打开浏览器开发者工具，查看性能面板

## 📊 预期效果

### ✅ 正确行为：

- 无论如何拖动画布，网格始终可见
- 网格点的间距在所有缩放级别下保持一致
- 拖动和缩放流畅，无明显卡顿
- 网格不干扰便签的拖拽和点击操作

### ❌ 如果仍有问题：

- 网格出现边界 → 可能需要进一步增大尺寸或改用其他渲染方案
- 网格不跟随移动 → 检查 transform 是否正确应用
- 性能问题 → 考虑降低网格尺寸或使用 Canvas API 渲染

## 🔄 替代方案（如有需要）

如果 100000px 仍不够用，可以考虑以下方案：

### 方案 A：动态网格重定位

监听画布偏移，当接近边界时自动调整网格位置：

```typescript
useEffect(() => {
  const gridOffset = {
    x: Math.floor(finalOffset.x / 100000) * 100000,
    y: Math.floor(finalOffset.y / 100000) * 100000,
  };
  // 动态调整网格位置
}, [finalOffset]);
```

### 方案 B：Canvas API 渲染

使用 HTML5 Canvas 动态绘制网格，可以实现真正的无限画布：

```typescript
const drawGrid = (ctx, viewport) => {
  // 只绘制可见区域的网格点
  const startX = Math.floor(-viewport.offset.x / gridSize) * gridSize;
  const startY = Math.floor(-viewport.offset.y / gridSize) * gridSize;
  // ... 绘制逻辑
};
```

### 方案 C：SVG 渲染

使用 SVG pattern 元素，浏览器原生支持无限重复：

```tsx
<svg style={{position: 'absolute', width: 0, height: 0}}>
  <defs>
    <pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse">
      <circle cx="1" cy="1" r="1" fill="rgba(0,0,0,0.1)" />
    </pattern>
  </defs>
</svg>
<div style={{background: 'url(#grid)'}} />
```

## 📝 总结

当前的修复方案通过以下方式解决了网格边界问题：

1. ✅ 将网格尺寸扩大 25 倍（4000px → 100000px）
2. ✅ 优化了网格的渲染结构，使其独立于便签内容
3. ✅ 保持了良好的性能和用户体验
4. ✅ 支持主题切换和网格显示/隐藏设置

对于绝大多数使用场景，这个方案已经提供了"无限"的视觉效果。如果未来有更极端的需求，可以考虑使用上述替代方案。

---

**修改文件清单：**

- ✏️ `src/pages/Canvas/index.module.css` - 网格样式定义
- ✏️ `src/pages/Canvas/index.tsx` - 网格渲染结构

**测试时间：** 2025 年 10 月 3 日
**状态：** ✅ 修复完成，等待测试验证
