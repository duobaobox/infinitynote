# 画布中心定位功能测试指南

## ✅ 已完成的改进

### 修改内容

将画布初始位置从**左上角**改为**中心**，符合行业标准（Miro、Figma、Excalidraw 等）。

### 修改的文件

- ✅ `src/store/canvasStore.ts` - 修改 DEFAULT_VIEWPORT 和相关函数

### 核心改动

```typescript
// 修改前（左上角起点）
const DEFAULT_VIEWPORT = {
  scale: 1,
  offset: { x: 0, y: 0 }, // 屏幕左上角对齐画布 (0,0)
};

// 修改后（中心起点）
const DEFAULT_VIEWPORT = {
  scale: 1,
  offset: {
    x: window.innerWidth / 2, // 屏幕中心对齐画布 (0,0)
    y: window.innerHeight / 2,
  },
};
```

---

## 🧪 测试清单

### 1️⃣ 初始加载测试

**测试步骤：**

1. 清除浏览器缓存和 LocalStorage
2. 刷新页面（F5）
3. 观察画布初始位置

**预期结果：**

- ✅ 网格应该居中显示
- ✅ 可以向四个方向自由拖动，空间大致均衡
- ✅ 不应该立即看到网格边界

**验证方法：**

```javascript
// 在浏览器控制台执行
console.log("当前视口偏移:", window.useCanvasStore.getState().viewport.offset);
// 应该输出类似: { x: 960, y: 540 } (根据屏幕尺寸而定)
```

---

### 2️⃣ 重置画布测试（Ctrl+0）

**测试步骤：**

1. 随意拖动画布到任意位置
2. 随意缩放画布
3. 按 `Ctrl+0` 重置画布

**预期结果：**

- ✅ 画布应该回到中心位置
- ✅ 缩放比例回到 1×
- ✅ 屏幕中心应该对齐画布坐标 (0, 0)

**验证方法：**

```javascript
// 重置后在控制台检查
const viewport = window.useCanvasStore.getState().viewport;
console.log("重置后偏移:", viewport.offset);
console.log("重置后缩放:", viewport.scale);
// offset 应该等于屏幕尺寸的一半
// scale 应该等于 1
```

---

### 3️⃣ 便签创建测试

**测试步骤：**

1. 重置画布（Ctrl+0）
2. 按 `Ctrl+N` 创建便签（或双击空白区域）
3. 观察便签位置
4. 查看便签的坐标

**预期结果：**

- ✅ 便签应该出现在屏幕中心
- ✅ 便签的画布坐标应该接近 (0, 0)
- ✅ 多次创建便签，应该围绕 (0, 0) 螺旋分布

**验证方法：**

```javascript
// 创建便签后在控制台执行
const notes = window.useNoteStore.getState().notes;
const firstNote = notes[0];
console.log("第一个便签位置:", firstNote?.position);
// 应该接近 { x: -135, y: -120 } (考虑便签尺寸居中偏移)
// 即便签中心在 (0, 0) 附近
```

---

### 4️⃣ 画布拖动测试

**测试步骤：**

1. 重置画布
2. 向**左上**拖动画布（约 1000px）
3. 向**右下**拖动画布（约 1000px）
4. 向**左下**拖动画布（约 1000px）
5. 向**右上**拖动画布（约 1000px）

**预期结果：**

- ✅ 四个方向都应该有大致相同的拖动空间
- ✅ 不应该很快看到网格边界
- ✅ 拖动应该流畅，无卡顿

**理论拖动范围：**

- 向任意方向可拖动约 **50,000 像素**
- 在 0.25× 缩放下，视觉空间扩大 4 倍

---

### 5️⃣ 缩放测试

**测试步骤：**

1. 重置画布
2. 使用 `Ctrl+滚轮` 放大到 2×
3. 观察画布中心是否偏移
4. 缩小到 0.25×
5. 观察画布中心是否保持

**预期结果：**

- ✅ 缩放时，画布中心应该保持在屏幕中心附近
- ✅ 不应该出现"缩放飞走"的情况
- ✅ 网格应该正确缩放

---

### 6️⃣ 画布切换测试

**测试步骤：**

1. 创建第二个画布
2. 在第一个画布上拖动到某个位置
3. 切换到第二个画布
4. 观察第二个画布的位置
5. 切换回第一个画布

**预期结果：**

- ✅ 新画布应该从中心位置开始
- ✅ 切换回原画布时，应该保持之前的位置
- ✅ 每个画布独立记录位置和缩放

---

### 7️⃣ 坐标验证测试

**测试步骤：**

1. 重置画布
2. 在浏览器控制台执行以下代码：

```javascript
// 获取当前视口状态
const canvasStore = window.useCanvasStore.getState();
const viewport = canvasStore.viewport;

console.log("=== 画布状态验证 ===");
console.log("屏幕尺寸:", {
  width: window.innerWidth,
  height: window.innerHeight,
});
console.log("视口偏移:", viewport.offset);
console.log("视口缩放:", viewport.scale);

// 计算屏幕中心对应的画布坐标
const screenCenterX = window.innerWidth / 2;
const screenCenterY = window.innerHeight / 2;
const canvasCenterX = (screenCenterX - viewport.offset.x) / viewport.scale;
const canvasCenterY = (screenCenterY - viewport.offset.y) / viewport.scale;

console.log("屏幕中心对应的画布坐标:", {
  x: canvasCenterX,
  y: canvasCenterY,
});
console.log("✅ 理论上应该接近 (0, 0)");

// 验证便签位置
const notes = window.useNoteStore.getState().notes;
if (notes.length > 0) {
  console.log("第一个便签坐标:", notes[0].position);
  console.log("第一个便签尺寸:", notes[0].size);
  // 便签中心应该接近 (0, 0)
  const noteCenterX = notes[0].position.x + notes[0].size.width / 2;
  const noteCenterY = notes[0].position.y + notes[0].size.height / 2;
  console.log("第一个便签中心:", { x: noteCenterX, y: noteCenterY });
}
```

**预期结果：**

- ✅ 视口偏移应该约等于屏幕尺寸的一半
- ✅ 屏幕中心对应的画布坐标应该接近 (0, 0)
- ✅ 第一个便签的中心应该接近 (0, 0)

---

### 8️⃣ 窗口大小变化测试

**测试步骤：**

1. 重置画布
2. 改变浏览器窗口大小
3. 再次重置画布（Ctrl+0）
4. 观察是否正确居中

**预期结果：**

- ✅ 重置后应该根据新的窗口尺寸居中
- ✅ offset 应该自动更新为新的屏幕尺寸的一半

---

### 9️⃣ 负坐标测试

**测试步骤：**

1. 重置画布
2. 向右拖动画布约 500px
3. 在屏幕中心创建便签
4. 查看便签坐标

**预期结果：**

- ✅ 便签坐标应该是**负数**
- ✅ 例如：x 约为 -250，y 约为 -120
- ✅ 证明现在支持负坐标，可以向左上扩展

**验证代码：**

```javascript
const notes = window.useNoteStore.getState().notes;
const lastNote = notes[notes.length - 1];
console.log("最新便签坐标:", lastNote.position);
// 如果向右拖动后创建，x 应该是负数
```

---

### 🔟 边界测试

**测试步骤：**

1. 重置画布
2. 持续向一个方向拖动，直到看到网格边界
3. 记录大约拖动了多远

**预期结果：**

- ✅ 从中心到边界约有 50,000 像素的距离
- ✅ 在 1× 缩放下，需要拖动很久才能看到边界
- ✅ 从中心向任意方向，拖动距离应该大致相同

---

## 📊 对比测试（修改前 vs 修改后）

### 修改前（左上角起点）

| 测试项         | 结果               |
| -------------- | ------------------ |
| 初始位置       | 左上角 (0, 0)      |
| 向左拖动空间   | 0 px（无法向左）   |
| 向上拖动空间   | 0 px（无法向上）   |
| 向右拖动空间   | ~50,000 px         |
| 向下拖动空间   | ~50,000 px         |
| 第一个便签坐标 | (960, 540) 附近    |
| 用户感受       | 受限制，不够"无限" |

### 修改后（中心起点）

| 测试项         | 结果                  |
| -------------- | --------------------- |
| 初始位置       | 画布中心 (0, 0)       |
| 向左拖动空间   | ~50,000 px            |
| 向上拖动空间   | ~50,000 px            |
| 向右拖动空间   | ~50,000 px            |
| 向下拖动空间   | ~50,000 px            |
| 第一个便签坐标 | (0, 0) 附近           |
| 用户感受       | ✅ 自由，真正的"无限" |

---

## 🐛 已知问题和注意事项

### 1. 旧数据兼容性

**问题：**

- 旧画布的 offset 可能仍然是 `{x: 0, y: 0}`
- 切换到旧画布时，会看到左上角

**解决方案：**

- 旧画布保持原有位置（向后兼容）
- 用户可以手动重置（Ctrl+0）
- 或者实现一次性迁移脚本

### 2. 便签坐标迁移

**问题：**

- 旧便签的坐标都是正数（基于左上角）
- 现在中心在 (0, 0)，旧便签可能看起来"跑远了"

**当前方案：**

- 不自动迁移旧数据
- 旧便签保持原坐标，但现在相对画布中心位置不同

**可选迁移方案：**

```javascript
// 如果需要迁移旧数据，可以运行：
async function migrateNotePositions() {
  const notes = useNoteStore.getState().notes;
  const offsetX = window.innerWidth / 2;
  const offsetY = window.innerHeight / 2;

  for (const note of notes) {
    // 将旧坐标转换为相对中心的坐标
    const newPosition = {
      x: note.position.x - offsetX,
      y: note.position.y - offsetY,
    };
    await useNoteStore.getState().updateNote(note.id, {
      position: newPosition,
    });
  }
}
```

### 3. 服务端渲染（SSR）

**问题：**

- `window` 对象在 SSR 时不存在

**已解决：**

- 使用 `typeof window !== 'undefined'` 检查
- SSR 时使用默认值 `{x: 960, y: 540}`

---

## ✅ 测试通过标准

测试全部通过后，应该满足：

1. ✅ 重置后屏幕中心对齐画布 (0, 0)
2. ✅ 新便签创建在画布 (0, 0) 附近
3. ✅ 四个方向拖动空间均衡
4. ✅ 支持负坐标
5. ✅ 缩放和拖动流畅
6. ✅ 画布切换正常
7. ✅ 窗口大小变化时重置正确

---

## 🚀 下一步优化建议

### 短期（可选）

- [ ] 添加"回到中心"快捷键（如 Home 键）
- [ ] 添加视觉提示，显示画布中心位置
- [ ] 优化网格，使用 SVG pattern 实现真无限

### 长期（可选）

- [ ] 实现四叉树空间索引，优化大量便签性能
- [ ] 添加小地图（Mini Map）显示当前位置
- [ ] 实现便签自动整理（对齐到网格）
- [ ] 添加画布导航历史（前进/后退）

---

## 📝 测试报告模板

测试完成后，请填写：

**测试时间：** ****\_\_\_\_****
**测试人员：** ****\_\_\_\_****
**浏览器：** ****\_\_\_\_****
**屏幕尺寸：** ****\_\_\_\_****

| 测试项     | 通过 | 备注 |
| ---------- | ---- | ---- |
| 初始加载   | ☐    |      |
| 重置画布   | ☐    |      |
| 便签创建   | ☐    |      |
| 画布拖动   | ☐    |      |
| 缩放功能   | ☐    |      |
| 画布切换   | ☐    |      |
| 坐标验证   | ☐    |      |
| 窗口变化   | ☐    |      |
| 负坐标支持 | ☐    |      |
| 边界测试   | ☐    |      |

**总体评价：** ****\_\_\_\_****

**问题记录：** ****\_\_\_\_****

---

开始测试吧！🎉
